---
title: "06.2-cod-RNAseq-alignment-genome"
author: "Kathleen Durkin"
date: "2024-04-16"
always_allow_html: true
output: 
  bookdown::html_document2:
    theme: cosmo
    toc: true
    toc_float: true
    number_sections: true
    code_folding: show
    code_download: true
  github_document:
    toc: true
    toc_depth: 3
    number_sections: true
    html_preview: true 
---

```{r setup, include=FALSE}
library(knitr)
knitr::opts_chunk$set(
  echo = TRUE,         # Display code chunks
  eval = FALSE,        # Evaluate code chunks
  warning = FALSE,     # Hide warnings
  message = FALSE,     # Hide messages
  comment = ""         # Prevents appending '##' to beginning of lines in code output
)
```

Code for aligning RNAseq data to reference genome, to be used on [Pacific cod RNAseq data](https://shedurkin.github.io/Roberts-LabNotebook/posts/projects/pacific_cod/2023_12_13_pacific_cod.html). 

- Raw reads found [here](https://owl.fish.washington.edu/nightingales/G_macrocephalus/30-943133806/)
- Trimmed reads: 
- Genome downloaded from [NCBI](https://www.ncbi.nlm.nih.gov/datasets/genome/GCF_031168955.1/), stored [here](https://owl.fish.washington.edu/halfshell/genomic-databank/GCF_031168955.1_ASM3116895v1_rna.fna) as a part of lab [genomic resources](https://robertslab.github.io/resources/Genomic-Resources/#gadus-macrocephalus-pacific-cod)

Note: Hisat2 pseudoalignment doesn't necessarily require input reads to be trimmed, provided they are of sufficient quality.

# Create a Bash variables file

This allows usage of Bash variables (e.g. paths to common directories) across R Markdown chunks.
```{r save-bash-variables-to-rvars-file, engine='bash', eval=TRUE}
{
echo "#### Assign Variables ####"
echo ""

echo "# Data directories"
echo 'export cod_dir=/home/shared/8TB_HDD_02/shedurkin/project-cod-temperature'
echo 'export output_dir_top=${cod_dir}/output/06.2-cod-RNAseq-alignment-genome'
echo 'export raw_fastqc_dir=${cod_dir}/output/05-cod-RNAseq-trimming/raw-fastqc'
echo 'export raw_reads_dir=${cod_dir}/data/05-cod-RNAseq-trimming/raw-reads'
echo 'export trimmed_fastqc_dir=${cod_dir}/output/05-cod-RNAseq-trimming/trimmed-fastqc'
echo 'export trimmed_reads_dir=${cod_dir}/output/05-cod-RNAseq-trimming/trimmed-reads'
echo 'export hisat2_output_dir=${output_dir_top}/hisat2'
echo ""


echo "# Input/Output files"
echo 'export genome_fasta_dir=${cod_dir}/data'
echo 'export genome_fasta_name="GCF_031168955.1_ASM3116895v1_genomic"'
echo 'export genome_fasta="${genome_fasta_dir}/${genome_fasta_name}"'
echo 'export genome_gff_name="GCF_031168955.1_ASM3116895v1"'
echo 'export genome_gff="${genome_gff_dir}/${genome_gff_name}"'
echo 'export hisat2_exons_name="G_macrocephalus_exon.tab"'
echo 'export hisat2_exons="${hisat2_output_dir}/${hisat_exons_name}"'
echo 'export hisat2_splice_sites_name="G_macrocephalus_splice_sites.tab"'
echo 'export hisat2_splice_sites="${hisat2_output_dir}/${hisat2_splice_sites_name}"'
echo 'export hisat2_index_name="G_macrocephalus_Hisat2_index.idx"'
echo 'export hisat2_index="${hisat2_output_dir}/${hisat2_index}"'


echo "# External data URLs and checksums"
echo 'export genome_fasta_url="https://owl.fish.washington.edu/halfshell/genomic-databank/GCF_031168955.1_ASM3116895v1_genomic.fna"'
echo 'export genome_fasta_checksum="5144890d4eceb0b258d92db3f35c681e"'
echo 'export genome_gff_url="https://owl.fish.washington.edu/halfshell/genomic-databank/GCF_031168955.1_ASM3116895v1.gff"'
echo 'export genome_gff_checksum="173fb3c159e474391c5c4aa1f7230024"'


echo "# Paths to programs"
echo 'export hisat2_exons=/home/shared/hisat2-2.2.1/hisat2_extract_exons.py'
echo 'export hisat2_splice_sites=/home/shared/hisat2-2.2.1/hisat2_extract_splice_sites.py'
echo 'export hisat2_build=/home/shared/hisat2-2.2.1/hisat2-build'
echo ""


echo "# Set number of CPUs to use"
echo 'export threads=20'
echo ""


echo "# Programs associative array"
echo "declare -A programs_array"
echo "programs_array=("
echo '[hisat2_exons]="${hisat2_exons}" \'
echo '[hisat2_splice_sites]="${hisat2_splice_sites}" \'
echo '[hisat2_build]="${hisat2_build}" \'
echo '[trinity_abund_to_matrix]="${trinity_abund_to_matrix}" \'
echo ")"
} > .bashvars

cat .bashvars
```

# Align to reference genome (Hisat2)

## Retrieving the reference genome and gff

```{r download-genome-fasta, engine='bash', eval=FALSE}
# Load bash variables into memory
source .bashvars

wget \
--directory-prefix ${genome_fasta_dir} \
--recursive \
--no-check-certificate \
--continue \
--no-host-directories \
--no-directories \
--no-parent \
--quiet \
--execute robots=off \
--accept "${genome_fasta_name}.fna" ${genome_fasta_url}
```

```{r download-genome-gff, engine='bash', eval=FALSE}
# Load bash variables into memory
source .bashvars

wget \
--directory-prefix ${genome_gff_dir} \
--recursive \
--no-check-certificate \
--continue \
--no-host-directories \
--no-directories \
--no-parent \
--quiet \
--execute robots=off \
--accept "${genome_gff_name}.gff" ${genome_gff_url}
```

```{r check-genome-dir, engine='bash', eval=TRUE}
# Load bash variables into memory
source .bashvars

ls -lh "${genome_fasta_dir}"
```


## Verify genome FastA MD5 checksum

```{r verify-genome-fasta-checksum, engine='bash', eval=TRUE}
# Load bash variables into memory
source .bashvars

cd "${genome_fasta_dir}"

# Checksums file contains other files, so this just looks for the sRNAseq files.
md5sum --check <<< "${genome_fasta_checksum}  ${genome_fasta_name}.fna"

```

```{r verify-genome-gff-checksum, engine='bash', eval=TRUE}
# Load bash variables into memory
source .bashvars

cd "${genome_fasta_dir}"

# Checksums file contains other files, so this just looks for the sRNAseq files.
md5sum --check <<< "${genome_gff_checksum}  ${genome_gff_name}.fna"

```

## Building Index

```{r create-exons-tab-file, engine='bash'}
# Create Hisat2 exons tab file
"${programs_array[hisat2_exons]}" \
"${genome_gff}.gff" \
> "${hisat2_exons}"
```

``` {r create-splice-sites-tab-file, engine='bash'}
# Create Hisat2 splice sites tab file
"${programs_array[hisat2_splice_sites]}" \
"${transcripts_gtf}" \
> "${hisat2_splice_sites}"
```

```{r build-hisat2-index, engine='bash'}
# Build Hisat2 reference index using splice sites and exons
"${programs_array[hisat2_build]}" \
"${genome_fasta}.fna" \
"${hisat2_index_name}" \
--exon "${hisat2_exons}" \
--ss "${hisat2_splice_sites}" \
-p "${threads}" \
2> hisat2-build_stats.txt
```

```{r check-index-file, engine='bash', eval=TRUE}
# Load bash variables into memory
source .bashvars

ls -lh ${hisat2_output_dir}
```


## Alignment
```{r hisat2-alignment, engine='bash'}
# Load bash variables into memory
source .bashvars

"${programs_array[hisat2]}" \
-x "${hisat2_index}" \
-1 "${fastq_list_R1}" \
-2 "${fastq_list_R2}" \
-S "${sample_name}".sam \
2> "${sample_name}"-hisat2_stats.txt

```



## Sample Quantification

```{r hisat2-quantification, engine='bash'}
# Load bash variables into memory
source .bashvars


```




## Trinity Matrix with Hisat2 Output

```{r hisat2-trinity-matrix, engine='bash', eval=TRUE}
# Load bash variables into memory
source .bashvars

cd ${hisat2_output_dir}

${programs_array[trinity_abund_to_matrix]} \
--est_method 'Hisat2' \
--gene_trans_map 'none' \
--out_prefix 'Hisat2' \
--name_sample_by_basedir ${hisat2_output_dir}/hisat2_quant_*/abundance.tsv

ls -lh ${hisat2_output_dir}
```
